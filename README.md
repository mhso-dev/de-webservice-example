# DE Shop - 데이터 엔지니어링 쇼핑몰 로깅 시스템

이 프로젝트는 데이터 엔지니어링 학습을 위한 쇼핑몰 애플리케이션으로, 사용자 행동 데이터 수집과 분석을 위한 포괄적인 로깅 시스템을 구현하고 있습니다.

## 로깅 아키텍처 개요

이 시스템은 다음과 같은 다층 로깅 아키텍처를 사용합니다:

- **파일 로깅**: 날짜별로 분리된 파일에 구조화된 로그 저장
- **데이터베이스 로깅**: 사용자 활동을 DB에 영구 저장
- **클라이언트-서버 통합 로깅**: 브라우저에서 수집된 데이터를 서버에 전송하여 통합 로깅

## 로그 유형 및 저장소

### 1. 파일 로그

두 가지 주요 로그 파일을 생성합니다:

- **애플리케이션 로그** (`app-YYYY-MM-DD.log`): 서버 작동, API 호출, 에러 등 시스템 레벨 로그
- **사용자 활동 로그** (`user_activity-YYYY-MM-DD.log`): 사용자 행동과 관련된 비즈니스 이벤트 로그

### 2. 데이터베이스 로그

`UserActivityLog` 테이블에 다음 정보를 저장합니다:

- 사용자 ID와 세션 ID
- 활동 유형(예: view, search, cart_add)
- 엔티티 타입과 ID(예: 제품 ID)
- 세부 정보(JSON 형식)
- IP 주소 및 사용자 에이전트
- 타임스탬프

## 로깅 메커니즘

### 서버 측 자동 로깅

Flask 미들웨어를 활용해 모든 웹 요청에 대한 자동 로깅을 구현합니다:

- `before_request`: 요청 정보와 사용자 정보 로깅
- `after_request`: 응답 결과와 처리 시간 로깅
- 에러 핸들링: 예외 발생 시 추적 정보 로깅

### 클라이언트 측 로깅

JavaScript를 통해 다음 사용자 행동 데이터를 수집합니다:

1. **페이지 체류 시간 측정**:
   - 페이지 진입/이탈 시간
   - 스크롤 깊이 추적
   - 페이지 전환 시 데이터 전송

2. **클릭 이벤트 추적**:
   - 클릭 요소 및 텍스트
   - 클릭 위치(백분율)
   - 장바구니 관련 액션 식별

3. **API를 통한 전송**:
   - `/api/log/dwell-time`: 체류 시간 데이터 전송
   - `/api/log/click-event`: 클릭 이벤트 데이터 전송

## 로그 데이터 구조

### 애플리케이션 로그 (JSON 형식)

```json
{
  "timestamp": "2025-05-14T11:45:47.652864",
  "level": "INFO",
  "message": "웹 서비스 시작 - 날짜별 로깅 설정 완료",
  "module": "daily_logger",
  "request_id": "uuid-string",
  "http": {
    "method": "GET",
    "path": "/products/11",
    "ip": "125.251.128.107"
  },
  "performance": {
    "processing_time_ms": 72.808
  }
}
```

### 사용자 활동 로그 (JSON 형식)

```json
{
  "timestamp": "2025-05-14T11:46:45.722945",
  "session_id": "4512dddf78e5682f4e94ca7700e0aefa",
  "event_type": "view",
  "user_id": 6,
  "entity_type": "product",
  "entity_id": 11,
  "endpoint": "products.detail",
  "method": "GET",
  "path": "/products/11",
  "args": {},
  "form": {},
  "ip_address": "125.251.128.107",
  "user_agent": "Unknown",
  "referrer": "http://15.164.34.189:5001/products/?category=2",
  "response_status": 200
}
```

## 주요 로깅 기능

### 1. 요청-응답 로깅

- 모든 HTTP 요청 및 응답 정보 로깅
- 처리 시간 및 성능 지표 수집
- 오류 발생 시 자세한 디버깅 정보 제공

### 2. 사용자 액티비티 로깅

- **페이지 뷰**: 사용자가 방문한 페이지 기록
- **페이지 체류 시간**: 페이지별 체류 시간 추적
- **클릭 행동**: 사용자 클릭 패턴 분석
- **장바구니 활동**: 장바구니 추가/제거/변경 기록
- **검색 활동**: 검색어 및 결과 수 기록

### 3. 세션 추적

- 쿠키 기반 세션 관리
- 세션별 활동 연계 분석 가능
- 인증된 사용자와 익명 사용자 구분

## 로그 관리 기능

- **로그 로테이션**: 날짜별 파일 분리 (TimedRotatingFileHandler)
- **보관 기간 관리**: 기본 30일 보관 후 자동 삭제
- **포맷팅**: JSON 구조화 로그 생성
- **마이크로초 정밀도**: 타임스탬프에 마이크로초 지원

## 로깅 구현 특징

1. **견고성**: 로깅 오류가 메인 애플리케이션 동작을 방해하지 않도록 설계
2. **유연성**: 필요에 따라 로그 레벨 및 상세도 조정 가능
3. **완전성**: 서버와 클라이언트 양쪽에서 데이터 수집하여 종합적인 사용자 행동 추적
4. **성능 최적화**: 비동기 클라이언트 로깅으로 사용자 경험 유지

## 활용 방안

이 로깅 시스템을 통해 다음과 같은 분석이 가능합니다:

- 사용자 행동 패턴 분석
- 인기 제품 및 카테고리 파악
- 전환율 및 이탈률 계산
- 사용자 여정(User Journey) 매핑
- A/B 테스트 결과 분석
- 페이지별 성능 모니터링

## 환경 설정

로깅 시스템 환경 설정은 다음 파일에서 관리됩니다:

- `app/__init__.py`: 로깅 초기화 및 미들웨어 설정
- `app/utils/daily_logger.py`: 커스텀 로깅 핸들러 구현
- `static/js/main.js`: 클라이언트 측 로깅 구현 
